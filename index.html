<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#00a884" />
    <meta name="description" content="WhatsaLink - Direct WhatsApp Chat" />
    <title>WhatsaLink</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD - Global Variables) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              whatsapp: { light: '#25D366', dark: '#075E54', bg: '#E5DDD5' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out forwards',
              'slide-up': 'slideUp 0.3s ease-out forwards',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
            }
          },
        },
      }
    </script>

    <style>
      body { background-color: #E5DDD5; -webkit-tap-highlight-color: transparent; }
      /* Hide scrollbar for Chrome, Safari and Opera */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- ICONS (Inline SVGs to remove dependencies) ---
      const Icon = ({ path, size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {path}
        </svg>
      );

      const Icons = {
        MessageCircle: <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />,
        Send: <><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></>,
        Wand2: <><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></>,
        Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
        Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        Eraser: <><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></>,
        ClipboardPaste: <><path d="M15 2H9a1 1 0 0 0-1 1v2c0 .6.4 1 1 1h6c.6 0 1-.4 1-1V3a1 1 0 0 0-1-1Z"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2M16 4h2a2 2 0 0 1 2 2v2M11 14h10"/><path d="m17 10 4 4-4 4"/></>,
        Globe: <><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>,
        Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
        RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />,
        X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
        Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />
      };

      // --- LOGIC: Phone Utils ---
      const formatPhoneNumber = (input, selectedCountryCode = '') => {
        let cleaned = input.replace(/[^\d+]/g, '');
        if (!cleaned) return null;

        // 1. Israeli 05 heuristic: 05... -> 972...
        if (cleaned.startsWith('05')) {
          return '972' + cleaned.substring(1);
        }

        // 2. Already international
        if (cleaned.startsWith('+')) return cleaned.substring(1);
        if (cleaned.startsWith('00')) return cleaned.substring(2);

        // 3. Apply manual country code
        if (selectedCountryCode) {
          let localNumber = cleaned;
          if (localNumber.startsWith('0')) localNumber = localNumber.substring(1);
          return selectedCountryCode.replace('+', '') + localNumber;
        }

        // 4. Return as is
        return cleaned;
      };

      // --- LOGIC: Gemini Service (Direct Fetch) ---
      // This removes the need for the external SDK which causes loading issues
      const extractPhoneNumberWithFetch = async (text) => {
        // Try to find API Key
        let apiKey = null;
        try {
            if (window.env && window.env.API_KEY) apiKey = window.env.API_KEY;
            else if (localStorage.getItem('GEMINI_API_KEY')) apiKey = localStorage.getItem('GEMINI_API_KEY');
        } catch(e) {}

        if (!apiKey) {
           console.warn("No API Key found. Skipping AI.");
           return null;
        }

        const model = "gemini-2.5-flash";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const prompt = `
          Analyze this text and extract the primary phone number for WhatsApp.
          Output JSON: { "found": boolean, "phoneNumber": string (digits only), "confidence": number }
          Rules: Remove non-digits. If starts with 05, replace 0 with 972.
          Text: "${text}"
        `;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: { responseMimeType: "application/json" }
            })
          });

          const data = await response.json();
          const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          if (jsonText) {
            const result = JSON.parse(jsonText);
            if (result.found && result.phoneNumber) return result;
          }
        } catch (error) {
          console.error("AI Fetch Error:", error);
        }
        return null;
      };

      // --- COMPONENT: NumberInput ---
      const COUNTRY_CODES = [
        { code: "", label: "Auto / Int'l", flag: "ðŸŒ" },
        { code: "972", label: "Israel (+972)", flag: "ðŸ‡®ðŸ‡±" },
        { code: "1", label: "USA/Can (+1)", flag: "ðŸ‡ºðŸ‡¸" },
        { code: "44", label: "UK (+44)", flag: "ðŸ‡¬ðŸ‡§" },
        { code: "91", label: "India (+91)", flag: "ðŸ‡®ðŸ‡³" },
        { code: "49", label: "Germany (+49)", flag: "ðŸ‡©ðŸ‡ª" },
        { code: "33", label: "France (+33)", flag: "ðŸ‡«ðŸ‡·" },
        { code: "55", label: "Brazil (+55)", flag: "ðŸ‡§ðŸ‡·" },
        { code: "7", label: "Russia (+7)", flag: "ðŸ‡·ðŸ‡º" },
      ];

      const NumberInput = ({ value, countryCode, onCountryCodeChange, onChange, onSubmit, onAiExtract, isAiLoading, onPasteError }) => {
        const [cleanNumber, setCleanNumber] = useState('');

        useEffect(() => {
          setCleanNumber(value.replace(/\D/g, ''));
        }, [value]);

        const isValidish = cleanNumber.length >= 5;
        const looksLikeMessyText = value.length > 20 || (value.includes(' ') && value.length > 10 && !value.startsWith('+'));
        const isIsraeli05 = value.replace(/\D/g, '').startsWith('05');

        const handleKeyDown = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (isValidish) onSubmit();
            else if (looksLikeMessyText) onAiExtract();
          }
        };

        const handlePaste = async () => {
          try {
            const text = await navigator.clipboard.readText();
            if (text) onChange(text);
            else if (onPasteError) onPasteError("Clipboard is empty");
          } catch (err) {
            if (onPasteError) onPasteError("Please paste manually");
          }
        };

        return (
          <div className="w-full max-w-md relative">
            <div className="relative group">
              <div className="absolute -inset-0.5 bg-gradient-to-r from-green-400 to-teal-500 rounded-2xl blur opacity-30 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
              <div className="relative bg-white rounded-xl shadow-xl p-1">
                
                {/* Header */}
                <div className="flex items-center gap-2 px-3 py-2 border-b border-gray-100">
                   <Icon path={Icons.Globe} size={14} className="text-gray-400" />
                   <select 
                     value={countryCode}
                     onChange={(e) => onCountryCodeChange(e.target.value)}
                     className="bg-transparent text-sm font-medium text-gray-600 focus:outline-none cursor-pointer w-full hover:text-green-600 transition-colors"
                   >
                     {COUNTRY_CODES.map(c => (
                       <option key={c.code} value={c.code}>{c.flag} {c.label}</option>
                     ))}
                   </select>
                   {isIsraeli05 && countryCode === "" && (
                     <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full whitespace-nowrap font-medium animate-pulse">ðŸ‡®ðŸ‡± 05 Detected</span>
                   )}
                </div>

                <textarea
                  value={value}
                  onChange={(e) => onChange(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder="Paste number here..."
                  className="w-full bg-transparent p-4 text-gray-800 placeholder-gray-400 focus:outline-none text-lg font-medium resize-none"
                  rows={looksLikeMessyText ? 3 : 1}
                  style={{ minHeight: '60px' }}
                />
                
                <div className="flex justify-between items-center px-2 pb-2 mt-2">
                  <div className="flex gap-2">
                    {value && (
                      <button onClick={() => onChange('')} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Clear">
                        <Icon path={Icons.Eraser} size={18} />
                      </button>
                    )}
                  </div>
                  <div className="flex gap-2 items-center">
                    <button onClick={handlePaste} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all" title="Paste">
                      <Icon path={Icons.ClipboardPaste} size={20} />
                    </button>

                    {looksLikeMessyText && (
                      <button onClick={onAiExtract} disabled={isAiLoading} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all ${isAiLoading ? 'bg-purple-100 text-purple-400' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}>
                        {isAiLoading ? <Icon path={Icons.Loader2} size={16} className="animate-spin" /> : <Icon path={Icons.Wand2} size={16} />}
                        {isAiLoading ? 'Working...' : 'Extract'}
                      </button>
                    )}

                    <button onClick={onSubmit} disabled={!isValidish} className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold text-white shadow-md transition-all ${isValidish ? 'bg-[#25D366] hover:bg-[#20bd5a] hover:shadow-lg hover:-translate-y-0.5' : 'bg-gray-300 cursor-not-allowed'}`}>
                      <span>Chat</span>
                      {isValidish && <Icon path={Icons.Send} size={16} className="ml-1" />}
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div className="mt-3 flex justify-between text-xs text-gray-400 px-2">
               <span>{countryCode ? `Prefix +${countryCode}` : "Auto-detect"}</span>
               {cleanNumber.length > 0 && <span>{cleanNumber.length} digits</span>}
            </div>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const [text, setText] = useState('');
        const [countryCode, setCountryCode] = useState('');
        const [history, setHistory] = useState([]);
        const [isAiLoading, setIsAiLoading] = useState(false);
        const [notification, setNotification] = useState(null);
        const [lastDeleted, setLastDeleted] = useState(null);
        const [undoTimeout, setUndoTimeout] = useState(null);
        const [deferredPrompt, setDeferredPrompt] = useState(null);

        useEffect(() => {
          const saved = localStorage.getItem('quickwa_history');
          if (saved) {
            try { setHistory(JSON.parse(saved)); } catch (e) {}
          }
          const handlePrompt = (e) => { e.preventDefault(); setDeferredPrompt(e); };
          window.addEventListener('beforeinstallprompt', handlePrompt);
          return () => window.removeEventListener('beforeinstallprompt', handlePrompt);
        }, []);

        useEffect(() => {
          localStorage.setItem('quickwa_history', JSON.stringify(history));
        }, [history]);

        const showNotification = (msg, type) => {
          setNotification({ msg, type });
          setTimeout(() => setNotification(null), 3000);
        };

        const handleStartChat = (numberToUse) => {
          const rawInput = numberToUse || text;
          let formattedNumber = numberToUse ? formatPhoneNumber(numberToUse, '') : formatPhoneNumber(rawInput, countryCode);
          
          if (!formattedNumber) {
              showNotification("Invalid number", 'error');
              return;
          }

          const newItem = {
            id: crypto.randomUUID(),
            number: formattedNumber,
            timestamp: Date.now(),
          };

          setHistory(prev => {
              const filtered = prev.filter(item => item.number !== formattedNumber);
              return [newItem, ...filtered].slice(0, 10);
          });

          window.open(`https://wa.me/${formattedNumber}`, '_blank');
          if (!numberToUse) setText('');
        };

        const handleAiExtract = async () => {
          setIsAiLoading(true);
          const result = await extractPhoneNumberWithFetch(text);
          setIsAiLoading(false);
          if (result && result.phoneNumber) {
            setCountryCode(''); 
            setText(result.phoneNumber);
            showNotification("Extracted!", 'success');
          } else {
            showNotification("No number found or Key missing.", 'error');
          }
        };

        const handleDelete = (id) => {
          const item = history.find(h => h.id === id);
          if (item) {
            if (undoTimeout) clearTimeout(undoTimeout);
            setLastDeleted(item);
            setHistory(prev => prev.filter(h => h.id !== id));
            setUndoTimeout(setTimeout(() => setLastDeleted(null), 5000));
          }
        };

        const handleUndo = () => {
          if (lastDeleted) {
            setHistory(prev => [...prev, lastDeleted].sort((a, b) => b.timestamp - a.timestamp));
            setLastDeleted(null);
            clearTimeout(undoTimeout);
          }
        };

        const handleInstall = async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') setDeferredPrompt(null);
          }
        };

        return (
          <div className="min-h-screen bg-[#E5DDD5] flex flex-col items-center py-12 px-4 relative overflow-hidden font-sans">
            <div className="absolute top-0 left-0 w-full h-32 bg-[#00a884] z-0 shadow-lg"></div>
            
            <div className="z-10 w-full flex flex-col items-center max-w-2xl">
              <div className="flex items-center gap-3 mb-8 text-white relative">
                <Icon path={Icons.MessageCircle} size={48} className="drop-shadow-md" />
                <h1 className="text-3xl font-bold tracking-tight drop-shadow-md">WhatsaLink</h1>
                {deferredPrompt && (
                  <button onClick={handleInstall} className="absolute -right-24 top-2 bg-white text-[#00a884] p-2 rounded-full shadow-lg hover:scale-110 hidden sm:flex">
                    <Icon path={Icons.Download} size={20} />
                  </button>
                )}
              </div>

              <div className="mb-8 text-center bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-sm border border-white/50 w-full max-w-md">
                <p className="text-gray-600 text-sm">Chat on WhatsApp without saving contacts.</p>
              </div>

              <NumberInput 
                value={text} countryCode={countryCode} onCountryCodeChange={setCountryCode}
                onChange={setText} onSubmit={() => handleStartChat()} onAiExtract={handleAiExtract}
                isAiLoading={isAiLoading} onPasteError={(msg) => showNotification(msg, 'error')}
              />

              {notification && (
                <div className={`mt-4 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in text-sm font-medium ${notification.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                  {notification.msg}
                </div>
              )}

              {/* History List */}
              {history.length > 0 && (
                <div className="mt-8 w-full max-w-md animate-fade-in">
                  <div className="flex justify-between items-center mb-3">
                    <h3 className="text-gray-500 text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
                      <Icon path={Icons.Clock} size={14} /> Recent
                    </h3>
                    <button onClick={() => { if(confirm("Clear history?")) setHistory([]); }} className="text-xs text-red-400 hover:text-red-600">Clear</button>
                  </div>
                  <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden max-h-64 overflow-y-auto no-scrollbar">
                    {history.map((item) => (
                      <div key={item.id} onClick={() => handleStartChat(item.number)} className="group flex items-center justify-between p-3 hover:bg-gray-50 border-b border-gray-50 last:border-0 cursor-pointer">
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                            <Icon path={Icons.MessageCircle} size={16} />
                          </div>
                          <div>
                            <p className="font-mono text-gray-800 text-sm font-medium">{item.number}</p>
                            <p className="text-[10px] text-gray-400">{new Date(item.timestamp).toLocaleDateString()}</p>
                          </div>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="p-2 text-gray-300 hover:text-red-500">
                          <Icon path={Icons.Trash2} size={16} />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Footer */}
              {deferredPrompt && (
                <div className="mt-8 sm:hidden">
                  <button onClick={handleInstall} className="flex items-center gap-2 px-4 py-2 bg-[#075E54] text-white rounded-lg shadow-md hover:bg-[#064e46] text-sm font-medium">
                    <Icon path={Icons.Download} size={16} /> Install App
                  </button>
                </div>
              )}
            </div>

            {/* Undo Toast */}
            {lastDeleted && (
              <div className="fixed bottom-6 z-50 flex items-center gap-3 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-xl animate-slide-up">
                  <span className="text-sm">Deleted</span>
                  <div className="h-4 w-px bg-gray-600 mx-1"></div>
                  <button onClick={handleUndo} className="flex items-center gap-1 text-green-400 font-bold text-sm tracking-wide">
                    <Icon path={Icons.RotateCcw} size={14} /> UNDO
                  </button>
                  <button onClick={() => setLastDeleted(null)} className="text-gray-400 hover:text-white ml-1">
                    <Icon path={Icons.X} size={16} />
                  </button>
              </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>